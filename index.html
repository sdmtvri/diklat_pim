<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>List Diklat Kepemimpinan Existing</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #1e3a5f 100%);
      position: relative;
      overflow: auto;
    }
    .gradient-bg::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
        linear-gradient(45deg, transparent 25%, rgba(255, 255, 255, 0.02) 25%, rgba(255, 255, 255, 0.02) 50%, transparent 50%, transparent 75%, rgba(255, 255, 255, 0.02) 75%);
      background-size: 100% 100%, 100% 100%, 40px 40px;
      pointer-events: none;
      z-index: -1;
    }
    .card-shadow {
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }
    .input-focus:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    .diklat-section {
      animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    .badge-blue {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }
    .info-box {
      border-left: 4px solid #3b82f6;
      background: linear-gradient(to right, rgba(59, 130, 246, 0.05), transparent);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full gradient-bg overflow-auto">
  <div class="min-h-full w-full py-8 px-4">
   <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
     <div class="mb-6">
      <h1 id="form-title" class="text-3xl font-bold text-white">LIST DIKLAT KEPEMIMPINAN EXISTING</h1>
      <p id="form-subtitle" class="text-blue-200 text-sm mt-1">Lembaga Penyiaran Publik TVRI</p>
     </div>
     <!-- Info Box -->
     <div class="info-box rounded-xl p-6 mb-6 bg-white">
      <p id="form-description" class="text-gray-700 text-sm leading-relaxed text-justify">Formulir ini digunakan untuk menghimpun dan memutakhirkan data riwayat Diklat Kepemimpinan (Diklat PIM) bagi seluruh Pejabat yang saat ini menjabat di lingkungan LPP TVRI.<br><br>
        Data yang dikumpulkan akan digunakan sebagai bahan pengecekan kesesuaian antara jabatan dengan pemenuhan kompetensi kepemimpinan, serta sebagai dasar penyusunan perencanaan pengembangan kompetensi pegawai ke depan.<br><br>
        Mohon Bapak/Ibu mengisi data dengan sebenar-benarnya dan lengkap. Apabila memiliki sertifikat Diklat, mohon dilampirkan sebagai bahan verifikasi.<br><br><span class="font-semibold text-gray-800">Terima kasih atas kerja sama Bapak/Ibu dalam mendukung tertib administrasi dan pengelolaan data pengembangan SDM.</span></p>
     </div>
    </div>

    <!-- Main Form Card -->
    <div class="bg-white rounded-3xl card-shadow p-8 mb-8">
     <form id="diklat-form">
      <!-- Data Pegawai Section -->
      <div class="mb-8">
       <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <span class="w-8 h-8 badge-blue rounded-lg flex items-center justify-center mr-3">
         <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
         </svg>
        </span> 
        Data Pegawai
       </h2>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
         <label for="nama" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap <span class="text-red-500">*</span></label>
         <input type="text" id="nama" name="nama" required class="w-full px-4 py-3 border border-gray-200 rounded-xl input-focus focus:border-blue-500 focus:outline-none transition-all" placeholder="Masukkan nama lengkap">
        </div>
        <div>
         <label for="nip" class="block text-sm font-medium text-gray-700 mb-2">NIP <span class="text-red-500">*</span></label>
         <input type="text" id="nip" name="nip" required maxlength="18" minlength="18" class="w-full px-4 py-3 border border-gray-200 rounded-xl input-focus focus:border-blue-500 focus:outline-none transition-all" placeholder="Masukkan NIP (18 angka)">
         <p class="text-xs text-gray-500 mt-1" id="nip-counter">0/18 angka</p>
         <p class="text-xs text-red-500 mt-1 hidden" id="nip-error">NIP harus terdiri dari 18 angka</p>
        </div>
       </div>
      </div>

      <!-- Diklat Status Section -->
      <div class="mb-8">
       <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <span class="w-8 h-8 badge-blue rounded-lg flex items-center justify-center mr-3">
         <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
         </svg>
        </span> 
        Status Diklat Kepemimpinan
       </h2>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
         <label class="block text-sm font-medium text-gray-700 mb-3">Apakah Anda sudah mengikuti Diklat Kepemimpinan? <span class="text-red-500">*</span></label>
         <div class="space-y-2">
          <label class="flex items-center cursor-pointer">
           <input type="radio" name="diklat_status" value="sudah" required class="w-4 h-4 text-blue-600 focus:ring-2 focus:ring-blue-500">
           <span class="ml-3 text-gray-700 font-medium">Sudah</span>
          </label>
          <label class="flex items-center cursor-pointer">
           <input type="radio" name="diklat_status" value="belum" required class="w-4 h-4 text-blue-600 focus:ring-2 focus:ring-blue-500">
           <span class="ml-3 text-gray-700 font-medium">Belum</span>
          </label>
         </div>
        </div>
       </div>
      </div>

      <!-- Satuan Kerja & Jabatan Section -->
      <div class="mb-8">
       <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <span class="w-8 h-8 badge-blue rounded-lg flex items-center justify-center mr-3">
         <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
         </svg>
        </span> 
        Satuan Kerja &amp; Jabatan
       </h2>
       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
         <label for="satuan_kerja" class="block text-sm font-medium text-gray-700 mb-2">Satuan Kerja <span class="text-red-500">*</span></label>
         <select id="satuan_kerja" name="satuan_kerja" required class="w-full px-4 py-3 border border-gray-200 rounded-xl input-focus focus:border-blue-500 focus:outline-none transition-all bg-white">
          <option value="">Pilih Satuan Kerja</option>
         </select>
        </div>
        <div>
         <label for="jabatan" class="block text-sm font-medium text-gray-700 mb-2">Jabatan <span class="text-red-500">*</span></label>
         <select id="jabatan" name="jabatan" required disabled class="w-full px-4 py-3 border border-gray-200 rounded-xl input-focus focus:border-blue-500 focus:outline-none transition-all bg-gray-50">
          <option value="">Pilih Satuan Kerja terlebih dahulu</option>
         </select>
        </div>
       </div>
      </div>

      <!-- Diklat Sections Container -->
      <div id="diklat-container"></div>

      <!-- Submit Button -->
      <div class="mt-8">
       <button type="submit" id="submit-btn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-4 px-6 rounded-xl transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span>Simpan Data</span>
       </button>
      </div>
     </form>
    </div>

    <!-- Data Viewer Section -->
    <div id="data-viewer-section" class="hidden bg-white rounded-3xl card-shadow p-8">
     <h2 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
      <span class="w-8 h-8 badge-blue rounded-lg flex items-center justify-center mr-3">
       <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
       </svg>
      </span>
      Data Tersimpan
     </h2>
     <div id="data-list" class="space-y-4"></div>
    </div>
   </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    // ========================================
    // CONSTANTS & CONFIG
    // ========================================
    const GOOGLE_APPS_SCRIPT_ENDPOINT = "https://script.google.com/macros/s/AKfycbyBiS9lkynQsxnRutyDeN_ixKewFovhWYpOPu3RRC1QABgnGolLUjb546zEigX284hHWA/exec";
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    const ALLOWED_FILE_TYPES = {
      'application/pdf': 'PDF',
      'image/jpeg': 'JPG',
      'image/png': 'PNG'
    };

    const allSatuanKerja = [
      { name: "Satuan Pengawasan Intern", eselon: "II" },
      { name: "TVRI Stasiun Jawa Barat", eselon: "II" },
      { name: "TVRI Stasiun Sumatera Selatan", eselon: "II" },
      { name: "TVRI Stasiun Sulawesi Selatan", eselon: "II" },
      { name: "TVRI Stasiun Kalimantan Timur", eselon: "II" },
      { name: "TVRI Stasiun D.I. Yogyakarta", eselon: "II" },
      { name: "TVRI Stasiun Bali", eselon: "II" },
      { name: "TVRI Stasiun Sumatera Barat", eselon: "II" },
      { name: "TVRI Stasiun Papua", eselon: "II" },
      { name: "Pusat Data dan Strategi", eselon: "II" },
      { name: "Pusat Pendidikan dan Pelatihan", eselon: "II" },
      { name: "TVRI Stasiun Jawa Timur", eselon: "II" },
      { name: "TVRI Stasiun Sulawesi Utara", eselon: "II" },
      { name: "TVRI Stasiun Jawa Tengah", eselon: "II" },
      { name: "TVRI Stasiun Sumatera Utara", eselon: "II" },
      { name: "TVRI Stasiun DKI Jakarta", eselon: "II" },
      { name: "TVRI Stasiun Aceh", eselon: "II" },
      { name: "TVRI Stasiun Maluku", eselon: "II" },
      { name: "TVRI Stasiun Jambi", eselon: "II" },
      { name: "TVRI Stasiun Kalimantan Selatan", eselon: "II" },
      { name: "TVRI Stasiun Kalimantan Barat", eselon: "III" },
      { name: "TVRI Stasiun Kalimantan Tengah", eselon: "III" },
      { name: "TVRI Stasiun Lampung", eselon: "III" },
      { name: "TVRI Stasiun Nusa Tenggara Timur", eselon: "III" },
      { name: "TVRI Stasiun Sulawesi Tenggara", eselon: "III" },
      { name: "TVRI Stasiun Sulawesi Barat", eselon: "III" },
      { name: "TVRI Stasiun Sulawesi Tengah", eselon: "III" },
      { name: "TVRI Stasiun Banten", eselon: "III" },
      { name: "TVRI Stasiun Kalimantan Utara", eselon: "III" },
      { name: "TVRI Stasiun Kepulauan Riau", eselon: "III" },
      { name: "TVRI Stasiun Gorontalo", eselon: "III" },
      { name: "TVRI Stasiun Riau", eselon: "III" },
      { name: "TVRI Stasiun Bengkulu", eselon: "III" },
      { name: "TVRI Stasiun Nusa Tenggara Barat", eselon: "III" },
      { name: "TVRI Stasiun Bangka Belitung", eselon: "III" },
      { name: "TVRI Stasiun Maluku Utara", eselon: "III" },
      { name: "TVRI Stasiun Papua Barat", eselon: "III" },
      { name: "Direktorat Umum", eselon: "IV" },
      { name: "Direktorat Keuangan", eselon: "IV" },
      { name: "Direktorat Teknik", eselon: "IV" },
      { name: "Direktorat Pengembangan Usaha", eselon: "IV" },
      { name: "Direktorat Program dan Berita", eselon: "IV" }
    ];

    const diklatByEselon = {
      "II": ["PKN", "PKA", "PKP"],
      "III": ["PKA", "PKP"],
      "IV": ["PKP"]
    };

    const diklatNames = {
      "PKN": "Pelatihan Kepemimpinan Nasional (PKN)",
      "PKP": "Pelatihan Kepemimpinan Pengawas (PKP)",
      "PKA": "Pelatihan Kepemimpinan Administrator (PKA)"
    };

    const defaultConfig = {
      form_title: "LIST DIKLAT KEPEMIMPINAN EXISTING",
      form_subtitle: "Lembaga Penyiaran Publik TVRI",
      form_description: "Formulir ini digunakan untuk menghimpun dan memutakhirkan data riwayat Diklat Kepemimpinan (Diklat PIM) bagi seluruh Pejabat yang saat ini menjabat di lingkungan LPP TVRI.\n\nData yang dikumpulkan akan digunakan sebagai bahan pengecekan kesesuaian antara jabatan dengan pemenuhan kompetensi kepemimpinan, serta sebagai dasar penyusunan perencanaan pengembangan kompetensi pegawai ke depan.\n\nMohon Bapak/Ibu mengisi data dengan sebenar-benarnya dan lengkap. Apabila memiliki sertifikat Diklat, mohon dilampirkan sebagai bahan verifikasi.\n\nTerima kasih atas kerja sama Bapak/Ibu dalam mendukung tertib administrasi dan pengelolaan data pengembangan SDM."
    };

    let currentRecords = [];

    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    
    function showToast(message, type = "success") {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      const bgColor = type === "success" ? "bg-green-500" : type === "error" ? "bg-red-600" : "bg-blue-500";
      
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-2`;
      toast.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          ${type === "success" 
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'}
        </svg>
        <span>${message}</span>
      `;
      
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function validateNIP(nip) {
      // NIP harus tepat 18 angka
      const nipRegex = /^\d{18}$/;
      return nipRegex.test(nip);
    }

    function validateFile(file) {
      if (!file) return { valid: false, error: "File tidak boleh kosong" };
      
      if (!ALLOWED_FILE_TYPES[file.type]) {
        return { valid: false, error: "Format file harus PDF, JPG, atau PNG" };
      }
      
      if (file.size > MAX_FILE_SIZE) {
        return { valid: false, error: `Ukuran file tidak boleh lebih dari ${MAX_FILE_SIZE / 1024 / 1024}MB` };
      }
      
      return { valid: true };
    }

    async function fileToBase64(file) {
      if (!file) return null;
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error("Gagal membaca file"));
        reader.readAsDataURL(file);
      });
    }

    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.disabled = true;
        button.innerHTML = `
          <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Menyimpan...</span>
        `;
      } else {
        button.disabled = false;
        button.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span>Simpan Data</span>
        `;
      }
    }

    // ========================================
    // FORM POPULATION FUNCTIONS
    // ========================================
    
    function populateSatuanKerja() {
      const select = document.getElementById("satuan_kerja");
      let options = '<option value="">Pilih Satuan Kerja</option>';
      
      allSatuanKerja.forEach(unit => {
        options += `<option value="${unit.name}" data-eselon="${unit.eselon}">${unit.name}</option>`;
      });
      
      select.innerHTML = options;
    }

    function updateJabatan(satuanKerjaName) {
      const jabatanSelect = document.getElementById("jabatan");
      
      if (!satuanKerjaName) {
        jabatanSelect.disabled = true;
        jabatanSelect.classList.add("bg-gray-50");
        jabatanSelect.innerHTML = '<option value="">Pilih Satuan Kerja terlebih dahulu</option>';
        return;
      }

      jabatanSelect.disabled = false;
      jabatanSelect.classList.remove("bg-gray-50");

      let options = '<option value="">Pilih Jabatan</option>';
      const isDirektorat = satuanKerjaName.startsWith("Direktorat");
      
      if (isDirektorat) {
        if (satuanKerjaName === "Direktorat Umum") {
          options += '<option value="Kepala Sub Bagian Tata Usaha Umum">Kepala Sub Bagian Tata Usaha Umum</option>';
          options += '<option value="Kepala Sub Bagian Tata Usaha Dewan Pengawas">Kepala Sub Bagian Tata Usaha Dewan Pengawas</option>';
          options += '<option value="Kepala Sub Bagian Tata Usaha Direktur Utama">Kepala Sub Bagian Tata Usaha Direktur Utama</option>';
          options += '<option value="Kepala Bagian Pengadaan">Kepala Bagian Pengadaan</option>';
        } else {
          options += '<option value="Kepala Sub Bagian Tata Usaha">Kepala Sub Bagian Tata Usaha</option>';
        }
      } else {
        if (satuanKerjaName === "Satuan Pengawasan Intern") {
          options += '<option value="Kepala Satuan Pengawasan Intern">Kepala Satuan Pengawasan Intern</option>';
        } else if (satuanKerjaName === "Pusat Data dan Strategi") {
          options += '<option value="Kepala Pusat Data dan Strategi">Kepala Pusat Data dan Strategi</option>';
        } else if (satuanKerjaName === "Pusat Pendidikan dan Pelatihan") {
          options += '<option value="Kepala Pusat Pendidikan dan Pelatihan">Kepala Pusat Pendidikan dan Pelatihan</option>';
        } else {
          options += '<option value="Kepala Stasiun TVRI">Kepala Stasiun TVRI</option>';
        }
        options += '<option value="Kepala Sub Bagian Tata Usaha">Kepala Sub Bagian Tata Usaha</option>';
      }

      jabatanSelect.innerHTML = options;
    }

    function generateDiklatSections() {
      const satuanKerjaSelect = document.getElementById("satuan_kerja");
      const jabatanSelect = document.getElementById("jabatan");
      const container = document.getElementById("diklat-container");
      
      container.innerHTML = "";

      const satuanKerjaName = satuanKerjaSelect.value;
      const jabatan = jabatanSelect.value;

      if (!satuanKerjaName || !jabatan) return;

      const unit = allSatuanKerja.find(u => u.name === satuanKerjaName);
      if (!unit) return;

      let diklats = [];
      
      // Determine which diklat types are needed based on position
      if (jabatan === "Kepala Stasiun TVRI" || jabatan === "Kepala Satuan Kerja" || 
          jabatan === "Kepala Satuan Pengawasan Intern" || 
          jabatan === "Kepala Pusat Data dan Strategi" || 
          jabatan === "Kepala Pusat Pendidikan dan Pelatihan") {
        diklats = diklatByEselon[unit.eselon] || [];
      } else if (jabatan.startsWith("Kepala Sub Bagian")) {
        diklats = ["PKP"];
      } else if (jabatan === "Kepala Bagian Pengadaan") {
        diklats = ["PKP", "PKA"];
      }

      if (diklats.length === 0) return;
      
      const sectionHeader = document.createElement("div");
      sectionHeader.className = "mb-6";
      sectionHeader.innerHTML = `
        <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
          <span class="w-8 h-8 badge-blue rounded-lg flex items-center justify-center mr-3">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
            </svg>
          </span>
          Data Diklat Kepemimpinan
        </h2>
      `;
      container.appendChild(sectionHeader);

      diklats.forEach(diklat => {
        const section = document.createElement("div");
        section.className = "diklat-section bg-gray-50 rounded-2xl p-6 mb-4 border-l-4 border-blue-600";
        section.innerHTML = `
          <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
            <span class="w-6 h-6 badge-blue text-white rounded-full flex items-center justify-center text-xs mr-2 font-bold">${diklat.charAt(diklat.length-1)}</span>
            ${diklatNames[diklat]}
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Sertifikat <span class="text-red-500">*</span></label>
              <input type="text" name="diklat_${diklat.toLowerCase()}_nomor" required
                class="w-full px-4 py-3 border border-gray-200 rounded-xl input-focus focus:border-blue-500 focus:outline-none transition-all bg-white"
                placeholder="Nomor sertifikat">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Sertifikat <span class="text-red-500">*</span></label>
              <input type="date" name="diklat_${diklat.toLowerCase()}_tanggal" required
                class="w-full px-4 py-3 border border-gray-200 rounded-xl input-focus focus:border-blue-500 focus:outline-none transition-all bg-white"
                max="${new Date().toISOString().split('T')[0]}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Penyelenggara <span class="text-red-500">*</span></label>
              <input type="text" name="diklat_${diklat.toLowerCase()}_penyelenggara" required
                class="w-full px-4 py-3 border border-gray-200 rounded-xl input-focus focus:border-blue-500 focus:outline-none transition-all bg-white"
                placeholder="Nama penyelenggara">
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Upload Berkas Diklat (PDF/JPG/PNG) <span class="text-red-500">*</span></label>
            <div class="border-2 border-dashed border-blue-300 rounded-xl p-4 text-center hover:border-blue-600 hover:bg-blue-50 transition-all cursor-pointer" 
                 id="file-drop-${diklat.toLowerCase()}">
              <input type="file" 
                     name="diklat_${diklat.toLowerCase()}_file" 
                     accept=".pdf,.jpg,.jpeg,.png" 
                     required
                     class="hidden" 
                     id="file-input-${diklat.toLowerCase()}">
              <svg class="w-8 h-8 mx-auto text-blue-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              <p class="text-sm text-gray-600 font-medium">Klik atau drag file ke sini</p>
              <p class="text-xs text-gray-500 mt-1">PDF, JPG, PNG (Maks. 5MB)</p>
              <p class="text-xs text-gray-600 mt-2 font-medium" id="file-name-${diklat.toLowerCase()}"></p>
            </div>
          </div>
        `;
        container.appendChild(section);

        // Setup file upload handlers
        const dropZone = section.querySelector(`#file-drop-${diklat.toLowerCase()}`);
        const fileInput = section.querySelector(`#file-input-${diklat.toLowerCase()}`);
        
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFileSelect(e.target, diklat.toLowerCase()));
        setupDragDrop(dropZone, fileInput, diklat.toLowerCase());
      });
    }

    function toggleDiklatSections() {
      const status = document.querySelector('input[name="diklat_status"]:checked')?.value;
      const container = document.getElementById("diklat-container");
      
      if (status === "sudah") {
        generateDiklatSections();
      } else {
        container.innerHTML = "";
      }
    }

    // ========================================
    // FILE HANDLING
    // ========================================
    
    function setupDragDrop(dropZone, fileInput, diklat) {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.add('border-blue-600', 'bg-blue-50');
        });
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.remove('border-blue-600', 'bg-blue-50');
        });
      });

      dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleFileSelect(fileInput, diklat);
        }
      });
    }

    function handleFileSelect(input, diklat) {
      const file = input.files[0];
      const fileName = document.getElementById(`file-name-${diklat}`);
      const dropZone = document.getElementById(`file-drop-${diklat}`);

      if (!file) {
        if (fileName) fileName.textContent = '';
        return;
      }

      const validation = validateFile(file);
      
      if (!validation.valid) {
        showToast(validation.error, 'error');
        input.value = '';
        if (fileName) fileName.textContent = '';
        if (dropZone) {
          dropZone.classList.remove('border-green-500', 'bg-green-50');
          dropZone.classList.add('border-red-300');
        }
        return;
      }

      if (fileName) {
        fileName.textContent = `âœ“ ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
      }
      
      if (dropZone) {
        dropZone.classList.add('border-green-500', 'bg-green-50');
        dropZone.classList.remove('border-red-300', 'border-blue-300');
      }
    }

    // ========================================
    // FORM SUBMISSION
    // ========================================
    
    async function handleSubmit(e) {
      e.preventDefault();

      const form = e.target;
      const submitBtn = document.getElementById("submit-btn");
      const formData = new FormData(form);
      
      // Validate NIP
      const nip = formData.get("nip");
      if (!validateNIP(nip)) {
        showToast("NIP harus terdiri dari 18 angka", "error");
        document.getElementById("nip-error").classList.remove("hidden");
        return;
      }
      document.getElementById("nip-error").classList.add("hidden");

      const diklatStatus = document.querySelector('input[name="diklat_status"]:checked')?.value;
      
      setButtonLoading(submitBtn, true);

      try {
        // Collect file data
        const filePKN = document.querySelector('#file-input-pkn')?.files[0];
        const filePKP = document.querySelector('#file-input-pkp')?.files[0];
        const filePKA = document.querySelector('#file-input-pka')?.files[0];

        // Prepare payload for Google Apps Script
        const payload = {
          nama: formData.get("nama"),
          nip: formData.get("nip"),
          satuan_kerja: formData.get("satuan_kerja"),
          jabatan: formData.get("jabatan"),
          diklat_status: diklatStatus,

          diklat_pkn_nomor: formData.get("diklat_pkn_nomor") || "",
          diklat_pkn_tanggal: formData.get("diklat_pkn_tanggal") || "",
          diklat_pkn_penyelenggara: formData.get("diklat_pkn_penyelenggara") || "",

          diklat_pkp_nomor: formData.get("diklat_pkp_nomor") || "",
          diklat_pkp_tanggal: formData.get("diklat_pkp_tanggal") || "",
          diklat_pkp_penyelenggara: formData.get("diklat_pkp_penyelenggara") || "",

          diklat_pka_nomor: formData.get("diklat_pka_nomor") || "",
          diklat_pka_tanggal: formData.get("diklat_pka_tanggal") || "",
          diklat_pka_penyelenggara: formData.get("diklat_pka_penyelenggara") || "",

          file_pkn_base64: filePKN ? await fileToBase64(filePKN) : "",
          file_pkn_name: filePKN?.name || "",
          file_pkn_type: filePKN?.type || "",

          file_pkp_base64: filePKP ? await fileToBase64(filePKP) : "",
          file_pkp_name: filePKP?.name || "",
          file_pkp_type: filePKP?.type || "",

          file_pka_base64: filePKA ? await fileToBase64(filePKA) : "",
          file_pka_name: filePKA?.name || "",
          file_pka_type: filePKA?.type || "",

          created_at: new Date().toISOString()
        };

        // Send to Google Apps Script
        const body = new URLSearchParams();
        body.append("data", JSON.stringify(payload));

        const response = await fetch(GOOGLE_APPS_SCRIPT_ENDPOINT, { 
          method: "POST", 
          body 
        });

        const result = await response.json();

        if (result.success) {
          showToast("Data berhasil disimpan dan file berhasil diupload!", "success");
          form.reset();
          document.getElementById("diklat-container").innerHTML = "";
          updateJabatan("");
          
          // Reset file displays
          document.querySelectorAll('[id^="file-name-"]').forEach(el => el.textContent = '');
          document.querySelectorAll('[id^="file-drop-"]').forEach(el => {
            el.classList.remove('border-green-500', 'bg-green-50', 'border-red-300');
            el.classList.add('border-blue-300');
          });
        } else {
          throw new Error(result.message || "Gagal menyimpan data");
        }
      } catch (error) {
        console.error("Error:", error);
        showToast("Gagal menyimpan data: " + error.message, "error");
      } finally {
        setButtonLoading(submitBtn, false);
      }
    }

    // ========================================
    // DATA VIEWER
    // ========================================
    
    const dataHandler = {
      onDataChanged(data) {
        currentRecords = data || [];
        
        const viewerSection = document.getElementById('data-viewer-section');
        const dataList = document.getElementById('data-list');
        
        if (currentRecords.length > 0) {
          viewerSection.classList.remove('hidden');
          dataList.innerHTML = '';
          
          currentRecords.forEach((record) => {
            const recordDiv = document.createElement('div');
            recordDiv.className = 'bg-gray-50 rounded-2xl p-6 border-l-4 border-blue-600';
            
            let diklatHTML = '';
            if (record.diklat_pkn_nomor) {
              diklatHTML += `<div class="mb-2"><span class="text-sm font-medium text-gray-700">PKN:</span> ${record.diklat_pkn_nomor} - ${record.diklat_pkn_tanggal} (${record.diklat_pkn_penyelenggara})</div>`;
            }
            if (record.diklat_pkp_nomor) {
              diklatHTML += `<div class="mb-2"><span class="text-sm font-medium text-gray-700">PKP:</span> ${record.diklat_pkp_nomor} - ${record.diklat_pkp_tanggal} (${record.diklat_pkp_penyelenggara})</div>`;
            }
            if (record.diklat_pka_nomor) {
              diklatHTML += `<div class="mb-2"><span class="text-sm font-medium text-gray-700">PKA:</span> ${record.diklat_pka_nomor} - ${record.diklat_pka_tanggal} (${record.diklat_pka_penyelenggara})</div>`;
            }
            
            recordDiv.innerHTML = `
              <div class="mb-4">
                <h3 class="font-semibold text-gray-800">${record.nama}</h3>
                <p class="text-sm text-gray-600">NIP: ${record.nip}</p>
                <p class="text-sm text-gray-600">${record.jabatan} - ${record.satuan_kerja}</p>
              </div>
              <div class="bg-white rounded-lg p-4">
                <p class="text-sm font-medium text-gray-700 mb-3">Data Diklat:</p>
                ${diklatHTML || '<p class="text-sm text-gray-400">Belum mengikuti diklat</p>'}
              </div>
              <p class="text-xs text-gray-500 mt-3">Disimpan: ${new Date(record.created_at).toLocaleString('id-ID')}</p>
            `;
            dataList.appendChild(recordDiv);
          });
        } else {
          viewerSection.classList.add('hidden');
        }
      }
    };

    // ========================================
    // CONFIG MANAGEMENT
    // ========================================
    
    async function onConfigChange(config) {
      const titleEl = document.getElementById("form-title");
      const subtitleEl = document.getElementById("form-subtitle");
      const descriptionEl = document.getElementById("form-description");
      
      if (titleEl) titleEl.textContent = config.form_title || defaultConfig.form_title;
      if (subtitleEl) subtitleEl.textContent = config.form_subtitle || defaultConfig.form_subtitle;
      if (descriptionEl) {
        const desc = config.form_description || defaultConfig.form_description;
        descriptionEl.innerHTML = desc.replace(/\n/g, '<br>');
      }
    }

    // ========================================
    // INITIALIZATION
    // ========================================
    
    async function init() {
      // Initialize Element SDK if available
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["form_title", config.form_title || defaultConfig.form_title],
            ["form_subtitle", config.form_subtitle || defaultConfig.form_subtitle],
            ["form_description", config.form_description || defaultConfig.form_description]
          ])
        });
      }

      // Initialize Data SDK if available
      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error("Failed to initialize Data SDK:", initResult.error);
        }
      }

      // Populate satuan kerja dropdown
      populateSatuanKerja();

      // Setup NIP input validation
      const nipInput = document.getElementById("nip");
      nipInput.addEventListener("input", (e) => {
        // Only allow numbers
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
        
        const counter = document.getElementById("nip-counter");
        counter.textContent = `${e.target.value.length}/18 angka`;
        
        // Show/hide error message
        const errorEl = document.getElementById("nip-error");
        if (e.target.value.length > 0 && e.target.value.length !== 18) {
          errorEl.classList.remove("hidden");
        } else {
          errorEl.classList.add("hidden");
        }
      });

      // Setup satuan kerja change handler
      document.getElementById("satuan_kerja").addEventListener("change", (e) => {
        updateJabatan(e.target.value);
        document.getElementById("jabatan").value = "";
        document.getElementById("diklat-container").innerHTML = "";
      });

      // Setup jabatan change handler
      document.getElementById("jabatan").addEventListener("change", () => {
        const diklatStatus = document.querySelector('input[name="diklat_status"]:checked')?.value;
        if (diklatStatus === "sudah") {
          generateDiklatSections();
        } else {
          document.getElementById("diklat-container").innerHTML = "";
        }
      });

      // Setup diklat status change handler
      document.querySelectorAll('input[name="diklat_status"]').forEach(radio => {
        radio.addEventListener('change', toggleDiklatSections);
      });

      // Setup form submission
      document.getElementById("diklat-form").addEventListener("submit", handleSubmit);
    }

    // Start the application
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
 </body>
</html>
